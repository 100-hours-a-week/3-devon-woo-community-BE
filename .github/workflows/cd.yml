name: CD


on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**/*.md'

env:
  BUILD_DIR: "."
  MODULE_NAME: "app-api"
  DOCKER_IMAGE_NAME: "techblog"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Gradlew 실행 권한 부여
        working-directory: ${{ env.BUILD_DIR }}
        run: chmod +x gradlew

      - name: 테스트 실행
        working-directory: ${{ env.BUILD_DIR }}
        run: ./gradlew test

      - name: 빌드 실행
        working-directory: ${{ env.BUILD_DIR }}
        run: ./gradlew :${{ env.MODULE_NAME }}:build -x test

      - name: Docker Hub 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Docker 메타데이터 추출
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Docker 이미지 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BUILD_DIR }}/${{ env.MODULE_NAME }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Slack 알림 전송 (CD)
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set. Skip Slack notification."
            exit 0
          fi

          STATUS="${{ job.status }}"
          REPO="${{ github.repository }}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"

          TEXT="[${REPO}] CD ${STATUS} - Docker 이미지 빌드/푸시 완료\n${RUN_URL}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${TEXT}\"}" \
            "$SLACK_WEBHOOK_URL"
