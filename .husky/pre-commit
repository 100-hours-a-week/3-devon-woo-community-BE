#!/usr/bin/env sh

echo "ğŸ¶ Husky pre-commit í›…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤."
echo "ğŸ” ë³€ê²½ëœ Java íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ í¬ë§¤í„°(Spotless)ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."

# ì €ì¥ì†Œ ë£¨íŠ¸ ê²½ë¡œ
REPO_ROOT=$(git rev-parse --show-toplevel)

# ì»¤ë°‹ì— í¬í•¨ëœ(staged) Java íŒŒì¼ ëª©ë¡
CHANGED_JAVA_FILES=$(git diff --cached --name-only -- '*.java')

if [ -z "$CHANGED_JAVA_FILES" ]; then
  echo "âœ… ë³€ê²½ëœ Java íŒŒì¼ì´ ì—†ì–´ í¬ë§¤í„°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
  exit 0
fi

# Spotlessì— ë„˜ê¸¸ íŒŒì¼ ëª©ë¡ì„ ì½¤ë§ˆ(,)ë¡œ ì´ì–´ ë¶™ì¸ ì ˆëŒ€ ê²½ë¡œë¡œ ìƒì„±
SPOTLESS_FILES=""
for file in $CHANGED_JAVA_FILES; do
  abs_path="$REPO_ROOT/$file"
  if [ -z "$SPOTLESS_FILES" ]; then
    SPOTLESS_FILES="$abs_path"
  else
    SPOTLESS_FILES="$SPOTLESS_FILES,$abs_path"
  fi
done

echo "ğŸ“ í¬ë§¤í„° ëŒ€ìƒ íŒŒì¼:"
echo "$CHANGED_JAVA_FILES"

# ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•´ì„œë§Œ Spotless í¬ë§¤í„° ì ìš©
./gradlew spotlessApply -PspotlessFiles="$SPOTLESS_FILES"
status=$?

if [ $status -ne 0 ]; then
  echo "âŒ pre-commit í›… ì‹¤íŒ¨: Spotless í¬ë§¤í„° ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
  exit $status
fi

# í¬ë§¤í„°ë¡œ ìˆ˜ì •ëœ ë‚´ìš©ì„ ë‹¤ì‹œ stage ì— ë°˜ì˜
git add $CHANGED_JAVA_FILES

echo "âœ… Java ì½”ë“œ í¬ë§· ì •ë¦¬ ì™„ë£Œ."
echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(unitTest)ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."

./gradlew unitTest
status=$?

if [ $status -ne 0 ]; then
  echo "âŒ pre-commit í›… ì‹¤íŒ¨: unitTest ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
  echo "   ì‹¤íŒ¨í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•œ ë’¤ ë‹¤ì‹œ ì»¤ë°‹í•´ì£¼ì„¸ìš”."
  exit $status
fi

echo "âœ… pre-commit í›… í†µê³¼: í¬ë§¤í„° ë° unitTest ëª¨ë‘ ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
