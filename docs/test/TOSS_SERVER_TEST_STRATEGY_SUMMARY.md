# 토스 서버 테스트 전략 요약

> 원문: [가치있는 테스트를 위한 전략과 구현](https://toss.tech/article/test-strategy-server)  
> 이 문서는 토스 서버 팀의 테스트 전략 글을 기반으로, 우리 프로젝트에 참고할 수 있는 핵심 개념과 실무 팁을 정리한 것입니다.

---

## 1. 테스트의 이상과 현실

- 테스트의 장점(버그 조기 발견, 리팩터링 안전망, 문서화 등)은 분명하지만, 실제 현장에서는
  - 아예 테스트가 없거나
  - 형식만 갖춘 테스트가 오히려 개발 속도를 떨어뜨리는 경우가 많습니다.
- 토스는 “모든 걸 테스트한다”는 이상보다는 **현실적으로 가치 있는 테스트**에 집중하는 전략을 세웠습니다.

**핵심 메시지**
- 모든 코드를 테스트하는 것은 불가능하고 비효율적입니다.
- 대신, **위험도가 높고 변경 가능성이 큰 부분**을 중심으로 테스트를 설계해야 합니다.

---

## 2. 무엇을 테스트할 것인가: 가치 기준

토스는 “테스트의 양”이 아니라 **테스트의 가치**를 기준으로 삼습니다.

- **비즈니스 임팩트가 큰 기능**
  - 금전 거래, 정산, 인증/인가, 규제/법적 요구사항 등은 작은 버그도 심각한 결과를 초래할 수 있으므로 테스트를 두텁게 가져갑니다.
- **변경이 잦고 복잡도가 높은 도메인**
  - 자주 바뀌는 정책, 복잡한 조건/분기를 가진 도메인 로직은 유닛/통합 테스트로 촘촘하게 보호합니다.
- **장애 발생 시 치명적인 부분**
  - 외부 결제/송금, 알림, 인증 등은 장애 비용이 크기 때문에 주요 플로우를 인수/통합 테스트로 검증합니다.

반대로 다음과 같은 부분은 과한 테스트를 지양합니다.

- 단순 DTO, 단순 위임/포워딩 로직
- UI/레이아웃과 같이 빠르게 변하는 표현 영역(서버 기준)

---

## 3. 테스트 피라미드: 단위–통합–E2E

토스도 전형적인 **테스트 피라미드**를 기본 틀로 사용하되, “실용적인 비율”에 맞게 조정합니다.

### 3.1 유닛 테스트 (Unit Test)

- 하나의 클래스/함수를 외부 의존성 없이 검증합니다.
- 속도가 매우 빠르고, 실패 시 원인 파악이 쉽습니다.

**역할**
- 도메인 규칙, 계산/검증 로직, 정책 객체 등의 **핵심 비즈니스 로직**을 촘촘하게 보호.
- 서비스/컨트롤러는 가능하면 도메인 로직을 위임하고, 그 로직을 유닛 테스트로 검증.

### 3.2 통합 테스트 (Integration Test)

- DB, 메시지 큐, 외부 시스템 연동 등 **여러 컴포넌트를 실제 환경에 가깝게** 올려서 검증합니다.

**역할**
- JPA 매핑, 쿼리, 트랜잭션, 스프링 설정/DI가 실제로 잘 동작하는지 확인.
- 도메인 규칙이 실제 인프라와 연동될 때 깨지지 않는지 검증.

### 3.3 인수/E2E 테스트 (End-to-End / Acceptance Test)

- 실제 사용자의 시나리오(예: “회원가입 → 본인 인증 → 계좌 연결 → 송금”)를 API 레벨에서 검증합니다.

**역할**
- 기능이 “겉으로 보기에는” 잘 동작하는지 확인하는 최종 안전망.
- 테스트 비용이 크므로, **핵심 플로우 위주로만 최소 개수**를 유지합니다.

---

## 4. 현실적인 테스트 전략: 균형 잡기

토스가 강조하는 것은 “이상적인 이론”이 아니라 **현실과 타협하면서도 가치를 극대화하는 전략**입니다.

- 모든 단계(유닛/통합/E2E)에 동일한 비율로 투자하지 않습니다.
- 각 레이어의 역할을 명확히 하고, 목적이 겹치는 테스트를 줄입니다.

**예시 판단 기준**
- 유닛 테스트로 충분히 검증 가능한 도메인 규칙 → 통합/E2E에서 중복 검증하지 않음.
- 인프라/설정 의존도가 큰 기능 → 통합/인수 테스트로 실제 환경 검증.
- 장애 영향이 큰 핵심 시나리오 → 인수 테스트를 반드시 둡니다.

---

## 5. 통합 테스트 설계: 현실성과 충실성

토스는 통합 테스트에서 **가능한 실제 환경과 유사하게** 테스트하려고 노력합니다.

- 실제 DB(H2 또는 실제 DB 엔진)를 사용하여 JPA 매핑과 쿼리를 검증합니다.
- 스프링 컨텍스트를 실제와 유사하게 로딩하여 설정/DI 문제를 조기에 발견합니다.

하지만 모든 것을 실제로 띄우는 것이 항상 최선은 아니기에, **테스트 대역(Test Double)** 을 상황에 따라 활용합니다.

### 5.1 테스트 대역 선택 기준

- **토스 외부 서비스**
  - 원하는 대로 조작하기 어렵고, 테스트 환경이 없거나 네트워크 불안정성이 크기 때문에
  - 대체로 **Fake 객체**(테스트용 구현체)를 만들어 사용합니다.

- **토스 내부 서비스**
  - 비즈니스 외적인 부수효과(예: 실제로 알림 발송, 로그 적재 등)가 있는 경우 → **Dummy 객체**로 대체.
  - 테스트 데이터 확보가 어렵거나 조작이 필요한 경우 → 모킹 프레임워크를 이용해 **Stub/Mock** 활용.
  - 그 외 대부분의 경우 → **실제 객체**를 가능한 한 사용.

핵심은 “가능한 실제와 가깝게, 그러나 비용과 안정성을 고려해 적절히 Test Double을 섞는다”는 점입니다.

---

## 6. Spring 기반 테스트 인프라 활용

글에서는 Spring TestContext Framework와 관련된 설정도 다룹니다.

### 6.1 TestExecutionListener와 mergeMode

- 스프링은 `DependencyInjectionTestExecutionListener`, `TransactionalTestExecutionListener` 등 범용 리스너를 제공합니다.
- 커스텀 리스너를 선언할 때 `mergeMode = MERGE_WITH_DEFAULTS` 를 설정하지 않으면
  - 기본 리스너들이 등록되지 않아
  - 의존성 주입, 트랜잭션 처리 등이 정상 작동하지 않을 수 있습니다.

**요약**
- 커스텀 테스트 리스너를 사용할 때는 기본 리스너와의 병합 여부를 항상 의식해야 합니다.

---

## 7. 테스트 코드 품질과 유지보수

토스는 “테스트가 많은 것”보다 **테스트가 개발 생산성과 품질에 실제로 기여하는지**를 중시합니다.

**지향점**
- 테스트는 **명확한 의도**를 가져야 하며, 실패 시 무엇이 잘못됐는지를 빠르게 알려야 합니다.
- 깨진 테스트를 “일단 무시하고 넘어가는” 문화는 피해야 합니다.
- 테스트 코드도 프로덕션 코드와 동일하게 리팩터링 대상입니다.

**지양점**
- 프로덕션 코드 변경 때마다 테스트가 불필요하게 자주 깨지는, 지나치게 구현 세부사항에 결합된 테스트.
- 의미 있는 assert 없이, 단순 호출만 하는 형식적인 테스트.

---

## 8. 우리 프로젝트에 적용해볼 수 있는 포인트

토스의 서버 테스트 전략에서 우리 프로젝트에 바로 가져올 수 있는 요소들을 정리하면 다음과 같습니다.

1. **핵심 도메인/위험 영역 우선 테스트**
   - 금전·권한·정책·조회수/좋아요 집계 등 비즈니스 임팩트가 큰 기능에 테스트 리소스를 집중합니다.
2. **테스트 피라미드를 실용적으로 적용**
   - 유닛 테스트를 가장 많이, 통합 테스트는 필요한 만큼, 인수 테스트는 핵심 시나리오 위주로 최소·강하게 유지합니다.
3. **테스트 대역 전략 명시**
   - 외부 서비스: Fake
   - 내부 서비스: 실제 객체 기본, 필요시 Dummy/Stub/Mock
4. **Spring 테스트 인프라를 체계적으로 사용**
   - 컨텍스트 로딩, 리스너, 트랜잭션 등 설정을 의식적으로 관리합니다.
5. **테스트 코드도 설계의 일부로 보기**
   - 테스트를 통해 설계를 검증하고 개선하며, 테스트 자체도 지속적으로 리팩터링합니다.

---

## 9. 마무리: 은탄환은 없다

원문이 강조하는 결론은 다음과 같습니다.

- 아무리 뛰어난 개발자라도 모든 세부 사항을 기억할 수 없고, 실수를 하게 됩니다.
- 테스트는 소프트웨어와 개발자 모두를 더 나아지게 만드는 도구입니다.
- 하지만 **모든 것을 테스트하는 것은 불가능**하며, 비효율적입니다.
- 따라서 상황에 맞는 **합리적이고 실용적인 테스트 전략**이 필수이며,
  - 프로젝트/팀/도메인에 맞춰 계속해서 조정해 나가야 합니다.

> 요약: “은탄환은 없지만, 좋은 테스트 전략은 분명 존재하고, 그것은 현실적인 균형 위에서 만들어진다.”

